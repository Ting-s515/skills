# 優化前後對照範例

本範例以「批次資料處理與發送」為情境，展示如何將口語化流程描述優化為結構化表達。
涵蓋所有優化原則：步驟撰寫、判斷分支、迴圈遍歷、外部服務互動。

---

## 優化前（口語化、結構鬆散）

```
查詢符合的資料，看快取有沒有 Key，
有的話就看 TTL 算一下時間，找到超過的那筆就發，
沒超過就跳過，如果截止時間過了也跳過。
沒有 Key 的話就直接找一筆能發的發出去，然後設快取。
```

---

## 優化後（結構化、可對應 Mermaid 流程圖）

**比對條件：** 主類別（`MainCategory`）+ 次類別（`SubCategory`）+ 編號（`ItemId`）

**處理流程：**

1. 查詢 `TargetTable` 資料表中，主類別、次類別與編號皆相符的資料：
   - 排除 `Deadline` 小於當前主機時間的資料
   - `Deadline` 為 `NULL` 時，視為無截止時間限制，不排除
   - 符合條件的資料依 pk `Id` 由小到大排序

2. 以主類別（`MainCategory`）+ 次類別（`SubCategory`）+ 編號（`ItemId`）
   組合為快取 Key，檢查快取中是否存在對應的 Key

3. **Key 存在時（快取期間內）：**
   取得該 Key 的剩餘過期秒數（TTL），
   計算「當前主機時間 + TTL 剩餘秒數」作為快取過期時間，
   依序遍歷步驟 1 的批次資料，逐筆判斷：

   - **未超過快取過期時間：** 跳過，繼續遍歷下一筆
   - **超過快取過期時間：** 檢查該筆截止時間（`Deadline`）：
     - **未過期（`Deadline` >= 當前時間）：** 加入待處理清單，寫入快取，結束遍歷
     - **已過期（`Deadline` < 當前時間）：** 跳過，繼續遍歷下一筆
   - **遍歷完畢皆無符合：** 本次無待處理資料，結束流程

4. **Key 不存在時（快取已過期或首次觸發）：**
   依序遍歷步驟 1 的批次資料，逐筆檢查截止時間（`Deadline`）：

   - **已過期：** 跳過，繼續遍歷下一筆
   - **未過期：** 加入待處理清單，寫入快取（過期時間設定為 `IntervalMinutes`），結束遍歷
   - **遍歷完畢皆無符合：** 本次無待處理資料，結束流程

---

## 對照說明

此範例展示了以下優化原則的實際應用：

| 優化原則 | 對應位置 |
|----------|----------|
| 明確資料來源 | 步驟 1：指明查詢 `TargetTable` 資料表 |
| 列舉篩選條件 | 步驟 1：拆成獨立子項目逐一列出 |
| Null 值處理 | 步驟 1：`Deadline` 為 `NULL` 的行為 |
| 排序規則 | 步驟 1：依 pk `Id` 由小到大 |
| 欄位名稱反引號 | 全文：`MainCategory`、`Deadline` 等 |
| 粗體標記分支 | 步驟 3-4：**Key 存在時**、**Key 不存在時** |
| 縮排呈現層級 | 步驟 3-4：子分支用縮排表示從屬關係 |
| 明確遍歷對象 | 步驟 3-4：「步驟 1 的批次資料」 |
| 遍歷完畢處理 | 步驟 3-4：「遍歷完畢皆無符合」的明確結束點 |
